<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hebrew Words STT (Sample Technique)</title>
    <!-- Mobile Debug Console Interceptor (enabled with ?debug=on) -->
    <script>
        (function () {
            try {
                var debug = new URL(location).searchParams.get('debug');
                if (debug === 'on') {
                    var s = document.createElement('script');
                    s.src = 'https://dev-tools.zurielyahav.com/debug/mobile-console-interceptor.min.js';
                    document.head.appendChild(s);
                }
            } catch (e) { }
        })();
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f6f7fb;
            color: #222;
        }

        .container {
            max-width: 520px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        h1 {
            margin: 0 0 8px;
            font-weight: 600;
            font-size: 22px;
        }

        .sub {
            margin: 0 0 16px;
            color: #666;
            font-size: 14px;
        }

        .word-box {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 120px;
            border-radius: 12px;
            background: #0ea5e9;
            color: #fff;
            font-size: 40px;
            letter-spacing: 1px;
            margin: 12px 0 8px;
        }

        .status {
            min-height: 20px;
            font-size: 14px;
            color: #0b5;
            margin: 8px 0 16px;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 10px 16px;
            font-size: 16px;
            cursor: pointer;
            background: #111827;
            color: #fff;
        }

        .btn.secondary {
            background: #e5e7eb;
            color: #111827;
        }

        .btn.mic {
            width: 72px;
            height: 72px;
            font-size: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #22c55e;
        }

        .btn.mic.listening {
            background: #16a34a;
            box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
        }

        .counter {
            font-size: 13px;
            color: #555;
            margin: 8px 0 4px;
            text="center";
        }

        .box {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 10px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
        }

        .recognized {
            direction: rtl;
        }

        .logs {
            max-height: 160px;
            overflow: auto;
            direction: ltr;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¤ ××™××•×Ÿ ××™×œ×™× ×‘×¢×‘×¨×™×ª</h1>
        <p class="sub">×××•×¨ ××ª ×”××™×œ×” ×©××•×¤×™×¢×”. ×›×©××–×”×™× ×”×ª×××”, ×¢×•×‘×¨×™× ×œ××™×œ×” ×”×‘××”.</p>

        <div id="wordBox" class="word-box">â€”</div>
        <div id="status" class="status">×œ×—×¥ ×¢×œ ×”××™×§×¨×•×¤×•×Ÿ ×›×“×™ ×œ×”×ª×—×™×œ</div>

        <div class="row" style="margin-bottom:12px;">
            <button id="micBtn" class="btn mic" type="button">ğŸ¤</button>
            <button id="prevBtn" class="btn secondary" type="button">â—€ï¸ ×”×§×•×“×</button>
            <button id="nextBtn" class="btn secondary" type="button">×”×‘× â–¶ï¸</button>
            <button id="restartBtn" class="btn secondary" type="button">×”×ª×—×œ ××—×“×©</button>
        </div>

        <div class="counter" id="counter">0 / 0</div>

        <div class="box recognized" style="margin-top:8px;">
            <div><strong>âŒ› ×‘×™× ×™×™×:</strong> <span id="interimText">â€”</span></div>
            <div><strong>âœ… ×¡×•×¤×™:</strong> <span id="finalText">â€”</span></div>
        </div>

        <div class="box logs" style="margin-top:10px;" id="logBox"></div>
    </div>

    <!-- Words dataset from the app -->
    <script src="js/words.js"></script>

    <script>
        // Utilities
        const logBox = document.getElementById('logBox');
        const logs = [];
        const log = (...args) => {
            try { console.log.apply(console, args); } catch (_) { }
            const msg = '[' + new Date().toLocaleTimeString() + '] ' + args.map(a => { try { return typeof a === 'string' ? a : JSON.stringify(a); } catch (e) { return String(a); } }).join(' ');
            logs.push(msg); while (logs.length > 200) logs.shift();
            logBox.innerHTML = logs.map(l => '<div>' + l + '</div>').join('');
            logBox.scrollTop = logBox.scrollHeight;
        };
        const stripNiqqud = (s) => (s || '').replace(/[\u05B0-\u05C7\u05C8-\u05CF]/g, '');
        const containsHeMatch = (heard, alts) => {
            const t = (heard || '').toLowerCase(); const tNo = stripNiqqud(t);
            return (alts || []).some(h => { const hL = (h || '').toLowerCase(); const hNo = stripNiqqud(hL); return t.includes(hL) || tNo.includes(hNo); });
        };

        // UI refs
        const wordBox = document.getElementById('wordBox');
        const statusEl = document.getElementById('status');
        const interimEl = document.getElementById('interimText');
        const finalEl = document.getElementById('finalText');
        const micBtn = document.getElementById('micBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const restartBtn = document.getElementById('restartBtn');
        const counterEl = document.getElementById('counter');

        // State
        let idx = 0; let recognition = null; let isListening = false; let keepListening = false;

        function updateCounter() { counterEl.textContent = (idx + 1) + ' / ' + words.length; }
        function showWord() { const w = words[idx]; wordBox.textContent = w && w.he ? w.he : 'â€”'; updateCounter(); log('ğŸ“‹ [WORD] Showing index', idx, '|', w && w.he); }
        function nextWord() { if (idx < words.length - 1) { idx++; } else { idx = 0; } showWord(); if (keepListening) restartRecognitionSoon(); }
        function prevWord() { if (idx > 0) { idx--; } else { idx = words.length - 1; } showWord(); if (keepListening) restartRecognitionSoon(); }

        // Recognition (exact sample technique)
        function initRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SR) { statusEl.textContent = '×”×“×¤×“×¤×Ÿ ××™× ×• ×ª×•××š ×‘×–×™×”×•×™ ×“×™×‘×•×¨'; log('âŒ SpeechRecognition not supported'); return false; }
            recognition = new SR(); recognition.lang = 'he-IL'; recognition.continuous = false; recognition.interimResults = true; recognition.maxAlternatives = 3;

            recognition.onstart = function () { isListening = true; micBtn.classList.add('listening'); statusEl.textContent = '×××–×™×Ÿ... ×××•×¨ ××ª ×”××™×œ×”'; interimEl.textContent = 'â€”'; log('ğŸ¤ onstart | lang:', recognition.lang); };

            recognition.onresult = function (event) {
                log('ğŸ“ onresult | results length =', event.results.length); let interim = ''; let final = '';
                for (let i = event.resultIndex; i < event.results.length; i++) { const r = event.results[i]; const t = (r[0] && r[0].transcript) || ''; const c = r[0] && r[0].confidence; log('ğŸ“ Result', i, '"' + t + '"', '| conf:', c, '| final:', r.isFinal); if (r.isFinal) final += t; else interim += t; }
                interimEl.textContent = interim || 'â€”'; if (final) { finalEl.textContent = final; log('âœ… Final:', final); }
                const current = words[idx] || {}; const heardNow = (interim || final || '').trim(); if (!heardNow) return;
                if (interim && containsHeMatch(interim, current.he_alternatives)) { log('âš¡ [FAST_PASS] Interim matched for', current.he); acceptAndAdvance(interim); return; }
                if (final && containsHeMatch(final, current.he_alternatives)) { log('âœ… [MATCH] Final matched for', current.he); acceptAndAdvance(final); } else { log('ğŸ” No match yet. Heard="' + heardNow + '" | Expecting any of:', current.he_alternatives); }
            };

            recognition.onerror = function (e) { log('âŒ onerror:', e && e.error, '| message:', e && e.message); isListening = false; micBtn.classList.remove('listening'); statusEl.textContent = '×©×’×™××” ×‘×–×™×”×•×™ ×”×“×™×‘×•×¨'; };
            recognition.onend = function () { log('ğŸ›‘ onend'); isListening = false; micBtn.classList.remove('listening'); statusEl.textContent = keepListening ? '××•×›×Ÿ ×œ××™×œ×” ×”×‘××”' : '×œ×—×¥ ×¢×œ ×”××™×§×¨×•×¤×•×Ÿ ×›×“×™ ×œ×”×ª×—×™×œ'; if (keepListening) restartRecognitionSoon(); };
            recognition.onspeechstart = function () { log('ğŸ—£ï¸ onspeechstart'); };
            recognition.onspeechend = function () { log('ğŸ”‡ onspeechend (processing...)'); };
            return true;
        }

        function startRecognition() { if (!recognition) { if (!initRecognition()) return; } try { recognition.lang = 'he-IL'; log('ğŸ¯ Starting recognition... lang:', recognition.lang); recognition.start(); } catch (err) { log('âŒ start error:', err && err.message || err); } }
        function stopRecognition() { try { recognition && recognition.stop(); } catch (_) { } }
        function restartRecognitionSoon() { setTimeout(() => { if (!isListening) startRecognition(); }, 120); }

        function acceptAndAdvance(transcript) { log('ğŸ¯ [ACCEPT] Heard =', transcript, '| Expected =', (words[idx] || {}).he_alternatives); stopRecognition(); setTimeout(() => { nextWord(); }, 80); }

        // Controls
        micBtn.addEventListener('click', () => { keepListening = !isListening ? true : false; if (isListening) { keepListening = false; log('ğŸ›‘ Stop requested'); stopRecognition(); } else { log('â–¶ï¸ Start requested'); startRecognition(); } });
        nextBtn.addEventListener('click', () => { nextWord(); });
        prevBtn.addEventListener('click', () => { prevWord(); });
        restartBtn.addEventListener('click', () => { idx = 0; showWord(); if (keepListening) restartRecognitionSoon(); });

        // Init
        if (!Array.isArray(window.words) || !words.length) { log('âŒ No words found. Make sure js/words.js is loaded.'); }
        showWord();
        log('ğŸ“± Hebrew Words STT page ready');
        log('ğŸ’¡ Use ?debug=on&debugHttp=https://mobile-logs.zurielyahav.com/log to stream logs');
    </script>
</body>

</html>